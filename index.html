<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
  <title>Mural – Wolno Mi</title>
  <style>
	html, body { margin:0; padding:0; background:#000; color:#fff;
	  font-family:"M PLUS Rounded 1c",sans-serif; overflow:hidden;
	}
	#bg, #fg { position:fixed; top:0; left:0; right:0; bottom:0; }
	#bg { z-index:-1; } #fg { z-index:1; }
	#sun { position:absolute; width:100%; height:100%;
	  opacity:0; transform:translateY(100%); background-repeat:no-repeat;
	}
	#sun.anim { transition:opacity 3s, transform 3s;
	  opacity:1; transform:translateY(0);
	}
	#info { position:absolute; top:50%; left:50%;
	  transform:translate(-50%,-50%); text-align:center;
	  max-width:1000px;
	}
	#info h2 { font-size:8em; margin:0; }
	#info h3, #info h4 { margin:0; }
	#console { position:absolute; bottom:0; left:0; width:100%; }
	#console p { margin:0; padding:0.5em; color:#aaa; background:#000; }
	#player_cont { position:fixed; top:0; left:0; right:0; bottom:0;
	  z-index:100; overflow:hidden;
	}
	#player_cont.hidden { display:none; }
  </style>
  <meta name="theme-color" content="#000">
</head>
<body>

  <div id="bg"><div id="sun"></div></div>
  <div id="fg">
	<div id="info">
	  <h2 id="time">--:--</h2>
	  <h3 id="date">…</h3>
	  <h4 id="desc"></h4>
	</div>
  </div>

  <div id="player_cont" class="hidden">
	<div id="player"></div>
  </div>

  <div id="console"><p id="log"></p></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script type="module">
  (function() {
	// ——————————————————————————————————————————————————————
	// 1. Ensure focus & global key listener
	// ——————————————————————————————————————————————————————
	window.addEventListener('load', () => {
	  if (!document.hasFocus()) window.focus();
	});

	window.addEventListener('keydown', (e) => {
	  console.log('keydown event:', e.code, e.key);
	  const log = d3.select('#log');
	  if (e.code === 'KeyP') {
		log.text('P key detected');
		const pc = d3.select('#player_cont');
		pc.classed('hidden', false);
		if (window.player && typeof player.nextVideo === 'function') {
		  player.nextVideo();
		}
	  }
	  // example for KEY_L if you need it:
	  if (e.code === 'KeyL') {
		log.text('L key detected');
	  }
	}, true);

	// ——————————————————————————————————————————————————————
	// 2. Time and Date
	// ——————————————————————————————————————————————————————
	const timeEl = d3.select('#time');
	const dateEl = d3.select('#date');
	function updateTime() {
	  const now = new Date();
	  timeEl.text(now.toLocaleTimeString('pl-PL', { hour:'2-digit', minute:'2-digit' }));
	  dateEl.text(now.toLocaleDateString('pl-PL', {
		weekday:'long', year:'numeric', month:'long', day:'numeric'
	  }));
	}
	setInterval(updateTime, 1000);
	updateTime();

	// ——————————————————————————————————————————————————————
	// 3. Weather (OpenWeatherMap)
	// ——————————————————————————————————————————————————————
	const apiKey = '6cd3e77384115078698b598e6f05201e';
	const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=Gliwice,PL&appid=${apiKey}&units=metric`;
	async function updateWeather() {
	  try {
		const resp = await fetch(weatherUrl);
		const data = await resp.json();
		const w = data.weather[0].main;
		const sunEl = document.getElementById('sun');
		const icons = {
		  Clear:'sunny.svg', Clouds:'cloudy.svg', Rain:'rainy.svg',
		  Snow:'snowy.svg', Thunderstorm:'thunder.svg',
		  Drizzle:'drizzle.svg', Mist:'foggy.svg', Fog:'foggy.svg'
		};
		sunEl.style.backgroundImage = `url('grafika/${icons[w]||'default.svg'}')`;
		sunEl.classList.add('anim');
	  } catch(err) {
		console.error('Weather fetch failed:', err);
	  }
	}
	updateWeather();

	// ——————————————————————————————————————————————————————
	// 4. YouTube IFrame API & Playlist Logic
	// ——————————————————————————————————————————————————————
	const tag = document.createElement('script');
	tag.src = "https://www.youtube.com/iframe_api";
	document.head.appendChild(tag);

	const playlist_id = 'PLuiikgCc3oFIsNvEBV2AJ63O4W9F6wG3J';
	window.onYouTubeIframeAPIReady = () => {
	  d3.select('#log').text('YT API ready');
	  window.player = new YT.Player('player', {
		height:'1080', width:'1920',
		playerVars:{
		  origin: location.origin,
		  enablejsapi:1, start:6, rel:0, fs:0,
		  autoplay:0, controls:0,
		  listType:'playlist', list:playlist_id
		},
		events:{
		  onReady: ev => {
			player.setShuffle(true);
		  },
		  onStateChange: ev => {
			const st = player.getPlayerState();
			if (st===-1 && !played) { d3.select('#log').text('unstarted'); }
			if (st===1) { // playing
			  if (!skipped) player.seekTo(6,true);
			  skipped=true; played=true;
			}
			if (st===-1 && played) {
			  player.stopVideo();
			  played=false; skipped=false;
			  d3.select('#player_cont').classed('hidden', true);
			}
		  }
		}
	  });
	};
	let played=false, skipped=false;
  })();
  </script>
</body>
</html>